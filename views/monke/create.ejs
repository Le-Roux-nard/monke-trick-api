<!DOCTYPE html>
<html>
	<head>
		<title>Monke Trick Generator</title>
		<link rel="icon" type="image/png" href="/static/monke/favicon.ico" sizes="96x96" />
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" />
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" />
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Bitter:400,700" />
		<link rel="stylesheet" href="/static/monke/assets/css/styles.css" />
		<link rel="stylesheet" href="/static/monke/assets/css/Article-List.css" />
		<link rel="stylesheet" href="/static/monke/assets/css/Footer-Dark.css" />
		<link rel="stylesheet" href="/static/monke/assets/css/glassmorphism.css" />
		<link rel="stylesheet" href="/static/monke/assets/css/home.css" />

		<style>
			body {
				height: 100vh;
			}
		</style>
	</head>
	<body data-base_url=<%= baseUrl %> >
		<%- include('../partials/navbar.ejs') %>
		<div class="d-xl-flex flex-row justify-content-center align-content-center">
			<div class="glass">
				<h1 class="center">Monke Trick Generator</h1>
				<form class="monke-form w-50 center mt-5" method="post">
					<div class="inputBx">
						<input type="url" id="pictureInput" required name="picture" placeholder="" />
						<span>Picture link</span>
						<i class="fas fa-image"></i>
					</div>
					<div class="inputBx">
						<input type="url" id="videoInput" name="video" required placeholder="" />
						<span>Youtube video link</span>
						<i class="fab fa-youtube"></i>
					</div>
					<div class="youtubeHolder">
						<div class="youtubePreview" id="youtubeControl">
							<img class="youtubePlaceholder" src="/static/monke/assets/img/youtube.png" />
							<div id="youtubePlayer"></div>
						</div>
					</div>
					<div class="alerts">
					</div>
					<div class="inputBx">
						<div class="result">
							<input type="text" placeholder="e" id="result" disabled />
							<input
								type="button"
								id="copy"
								value="Copy"
								onclick="navigator.clipboard.writeText(document.getElementById('result').value);"
							/>
							<input type="button" id="submit" value="Submit" onclick="sendForm()" />
						</div>
					</div>
				</form>
			</div>
		</div>
		<script defer>
			//form part
			document.getElementById("videoInput").addEventListener("change", function () {
				var url = document.getElementById("videoInput").value;
				let regex =
					/(?:https?:)?(?:\/\/)?(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube(?:-nocookie)?\.com\S*?[^\w\s-])([\w-]{11})(?=[^\w-]|$)(?![?=&+%\w.-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/;
				let regexResult = regex.exec(url) ?? undefined;

				let playerHolder = document.getElementById("youtubeControl");

				if (regexResult && regexResult[1]) {
					this.setAttribute("isValid", true);
					player?.loadVideoById(regexResult[1]);
					playerHolder.setAttribute("isValid", true);
				} else {
					player?.stopVideo();
					this.setAttribute("isValid", false);
					playerHolder.setAttribute("isValid", false);
				}
			});

			document.getElementById("pictureInput").addEventListener("change", function () {
				var url = document.getElementById("pictureInput").value;
				let image = new Image();
				image.onload = () => {
					document.querySelector(".youtubePlaceholder").src = url;
				};

				image.onerror = () => {
					this.setAttribute("isValid", false);
					document.querySelector(".youtubePlaceholder").src = "/static/monke/assets/img/youtube.png";
				};

				image.src = url;
			});

			function sendForm() {
				console.log("send form");
				const payload = {
					picture: document.getElementById("pictureInput").value,
					video: document.getElementById("videoInput").value,
				};

				const xhr = new XMLHttpRequest();
				xhr.onload = function () {
					console.log(this.responseText);
					try {
						const response = JSON.parse(this.responseText);
						if (response.shortUrl) {
							let resultInput = document.querySelector("#result");
							resultInput.value = response.shortUrl;
							resultInput.placeholder = response.shortUrl;
						}
					} catch (e) {
						let div = document.createElement("div");
						div.classList.add("alert", "alert-danger");
						div.innerText = this.responseText;
						document.querySelector(".alerts").innerHTML = div.outerHTML;
					}
				};
				let baseUrl = document.querySelector("body").dataset.base_url;
				console.log(baseUrl)
				console.log(`${baseUrl}/create`)
				xhr.open("POST", `${baseUrl ?? ""}/create`, true);
				xhr.setRequestHeader("Content-type", "application/json; charset=UTF-8");
				xhr.send(JSON.stringify(payload));
			}
		</script>
		<script>
			//youtube part
			var tag = document.createElement("script");

			tag.src = "https://www.youtube.com/iframe_api";
			var firstScriptTag = document.getElementsByTagName("script")[0];
			firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

			var player,
				playing = false;
			function onYouTubeIframeAPIReady() {
				player = new YT.Player("youtubePlayer", {
					width: 520,
					height: 326,
					// videoId: "GHAV07v382o",
					playerVars: { controls: 0, loop: 1, disablekb: 1, iv_load_policy: 3, rel: 0, showinfo: 0 },
					events: {
						onReady: onPlayerReady,
					},
				});
			}

			function onPlayerReady(event) {
				player.stopVideo();
				player.clearVideo();
				document.getElementById("youtubeControl").addEventListener("click", () => {
					if (document.querySelector(".youtubePlaceholder").height > 0) return;
					playing ? player.pauseVideo() : player.playVideo();
					playing = !playing;
				});
			}
		</script>
	</body>
</html>
